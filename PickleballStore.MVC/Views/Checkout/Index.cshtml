@model CheckoutViewModel


<!-- header -->
<header id="header" class="header-default">
    <div class="px_15 lg-px_40">
        <div class="row wrapper-header align-items-center">
            <div class="col-md-4 col-3 tf-lg-hidden">
                <a href="#mobileMenu" data-bs-toggle="offcanvas" aria-controls="offcanvasLeft">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="16" viewBox="0 0 24 16"
                         fill="none">
                        <path d="M2.00056 2.28571H16.8577C17.1608 2.28571 17.4515 2.16531 17.6658 1.95098C17.8802 1.73665 18.0006 1.44596 18.0006 1.14286C18.0006 0.839753 17.8802 0.549063 17.6658 0.334735C17.4515 0.120408 17.1608 0 16.8577 0H2.00056C1.69745 0 1.40676 0.120408 1.19244 0.334735C0.978109 0.549063 0.857702 0.839753 0.857702 1.14286C0.857702 1.44596 0.978109 1.73665 1.19244 1.95098C1.40676 2.16531 1.69745 2.28571 2.00056 2.28571ZM0.857702 8C0.857702 7.6969 0.978109 7.40621 1.19244 7.19188C1.40676 6.97755 1.69745 6.85714 2.00056 6.85714H22.572C22.8751 6.85714 23.1658 6.97755 23.3801 7.19188C23.5944 7.40621 23.7148 7.6969 23.7148 8C23.7148 8.30311 23.5944 8.59379 23.3801 8.80812C23.1658 9.02245 22.8751 9.14286 22.572 9.14286H2.00056C1.69745 9.14286 1.40676 9.02245 1.19244 8.80812C0.978109 8.59379 0.857702 8.30311 0.857702 8ZM0.857702 14.8571C0.857702 14.554 0.978109 14.2633 1.19244 14.049C1.40676 13.8347 1.69745 13.7143 2.00056 13.7143H12.2863C12.5894 13.7143 12.8801 13.8347 13.0944 14.049C13.3087 14.2633 13.4291 14.554 13.4291 14.8571C13.4291 15.1602 13.3087 15.4509 13.0944 15.6653C12.8801 15.8796 12.5894 16 12.2863 16H2.00056C1.69745 16 1.40676 15.8796 1.19244 15.6653C0.978109 15.4509 0.857702 15.1602 0.857702 14.8571Z"
                              fill="currentColor"></path>
                    </svg>
                </a>
            </div>
            <div class="col-xl-3 col-md-4 col-6">
                <a asp-controller="Home" asp-action="Index" class="logo-header">
                    <img src="~/images/logo/logo.svg" alt="logo" class="logo">
                </a>
            </div>
            <div class="col-xl-6 tf-md-hidden">
                <nav class="box-navigation text-center">
                    <ul class="box-nav-ul d-flex align-items-center justify-content-center gap-30">
                        <li class="menu-item">
                            <a asp-controller="Home" asp-action="Index" class="item-link">Home</a>
                        </li>
                        <li class="menu-item">
                            <a asp-controller="Shop" asp-action="Index" class="item-link">Shop</a>
                        </li>
                        <li class="menu-item position-relative">
                            <a href="#" class="item-link">Pages<i class="icon icon-arrow-down"></i></a>
                            <div class="sub-menu submenu-default">
                                <ul class="menu-list">
                                    <li>
                                        <a asp-controller="Cart" asp-action="Index"
                                           class="menu-link-text link text_black-2 position-relative">
                                            View Cart
                                        </a>
                                    </li>
                                    <li>
                                        <a asp-controller="Checkout" asp-action="Index"
                                           class="menu-link-text link text_black-2 position-relative">
                                            Check Out
                                        </a>
                                    </li>
                                    <li class="menu-item-2">
                                        <a href="#" class="menu-link-text link text_black-2">My Account</a>
                                        <div class="sub-menu submenu-default">
                                            <ul class="menu-list">
                                                <li>
                                                    <a asp-controller="Orders" asp-action="Index"
                                                       class="menu-link-text link text_black-2">My Orders</a>
                                                </li>
                                                <li>
                                                    <a asp-controller="Orders" asp-action="Details"
                                                       class="menu-link-text link text_black-2">
                                                        My Order
                                                        Details
                                                    </a>
                                                </li>
                                                <li>
                                                    <a asp-controller="Address" asp-action="Index"
                                                       class="menu-link-text link text_black-2">My Address</a>
                                                </li>
                                                <li>
                                                    <a asp-controller="Account" asp-action="AccountDetails"
                                                       class="menu-link-text link text_black-2">
                                                        My Account Details
                                                    </a>
                                                </li>
                                                <li>
                                                    <a asp-controller="Wishlist" asp-action="MyWishlist"
                                                       class="menu-link-text link text_black-2">My Wishlist</a>
                                                </li>
                                            </ul>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </li>
                        <li class="menu-item position-relative">
                            <a href="#" class="item-link">Blog</a>
                        </li>
                        <li class="menu-item">
                            <a href="https://themeforest.net/item/ecomus-ultimate-html5-template/53417990?s_rank=3"
                               class="item-link">Buy now</a>
                        </li>
                    </ul>
                </nav>
            </div>
            <div class="col-xl-3 col-md-4 col-3">
                <ul class="nav-icon d-flex justify-content-end align-items-center gap-20">
                    <li class="nav-search">
                        <a href="#canvasSearch" data-bs-toggle="offcanvas"
                           aria-controls="offcanvasLeft" class="nav-icon-item">
                            <i class="icon icon-search"></i>
                        </a>
                    </li>
                    <li class="nav-account">
                        <a href="#login" data-bs-toggle="modal" class="nav-icon-item">
                            <i class="icon icon-account"></i>
                        </a>
                    </li>
                    <li class="nav-wishlist">
                        <a asp-controller="Wishlist" asp-action="Index" class="nav-icon-item">
                            <i class="icon icon-heart"></i><span class="count-box">0</span>
                        </a>
                    </li>
                    <li class="nav-cart">
                        <a href="#shoppingCart" data-bs-toggle="modal" class="nav-icon-item">
                            <i class="icon icon-bag"></i><span class="count-box" id="basketTotalBadge">0</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</header>
<!-- /header -->

<div class="tf-page-title">
    <div class="container-full">
        <div class="heading text-center">Check Out</div>
    </div>
</div>

<section class="flat-spacing-11">
    <div class="container">
        <form asp-action="Index" asp-controller="Checkout" method="post" id="checkoutForm">
            <div class="tf-page-cart-wrap layout-2">
                <div class="tf-page-cart-item">
                    <h5 class="fw-5 mb_20">Billing details</h5>
                    
                    <div class="box grid-2">
                        <fieldset class="fieldset">
                            <label asp-for="FirstName">First Name</label>
                            <input asp-for="FirstName" type="text" class="form-control" />
                            <span asp-validation-for="FirstName" class="text-danger"></span>
                        </fieldset>
                        <fieldset class="fieldset">
                            <label asp-for="LastName">Last Name</label>
                            <input asp-for="LastName" type="text" class="form-control" />
                            <span asp-validation-for="LastName" class="text-danger"></span>
                        </fieldset>
                    </div>

                    <fieldset class="box fieldset">
                        <label asp-for="Country">Country/Region</label>
                        <div class="select-custom">
                            <select asp-for="Country" class="tf-select w-100">
                                <option value="">---</option>
                                <option value="Azerbaijan">Azerbaijan</option>
                                <option value="Turkey">Turkey</option>
                                <option value="United States">United States</option>
                                <option value="United Kingdom">United Kingdom</option>
                            </select>
                        </div>
                        <span asp-validation-for="Country" class="text-danger"></span>
                    </fieldset>

                    <fieldset class="box fieldset">
                        <label asp-for="City">Town/City</label>
                        <input asp-for="City" type="text" class="form-control" />
                        <span asp-validation-for="City" class="text-danger"></span>
                    </fieldset>

                    <fieldset class="box fieldset">
                        <label asp-for="Address">Address</label>
                        <input asp-for="Address" type="text" class="form-control" />
                        <span asp-validation-for="Address" class="text-danger"></span>
                    </fieldset>

                    <fieldset class="box fieldset">
                        <label asp-for="PostalCode">Postal Code</label>
                        <input asp-for="PostalCode" type="text" class="form-control" />
                        <span asp-validation-for="PostalCode" class="text-danger"></span>
                    </fieldset>

                    <fieldset class="box fieldset">
                        <label asp-for="PhoneNumber">Phone Number</label>
                        <input asp-for="PhoneNumber" type="tel" class="form-control" />
                        <span asp-validation-for="PhoneNumber" class="text-danger"></span>
                    </fieldset>

                    <fieldset class="box fieldset">
                        <label asp-for="Email">Email</label>
                        <input asp-for="Email" type="email" class="form-control" />
                        <span asp-validation-for="Email" class="text-danger"></span>
                    </fieldset>

                    <fieldset class="box fieldset">
                        <label asp-for="OrderNotes">Order notes (optional)</label>
                        <textarea asp-for="OrderNotes" rows="4"></textarea>
                    </fieldset>
                </div>

                <!-- Order Summary -->
                <div class="tf-page-cart-footer">
                    <div class="tf-cart-footer-inner">
                        <h5 class="fw-5 mb_20">Your order</h5>

                        <style>
                            .wrap-checkout-product {
                                list-style: none;
                                padding: 0;
                                margin: 0 0 20px 0;
                            }

                            .checkout-product-item {
                                display: flex;
                                gap: 15px;
                                align-items: flex-start;
                                padding: 15px 0;
                                border-bottom: 1px solid #eee;
                            }

                                .checkout-product-item:last-child {
                                    border-bottom: none;
                                }

                                .checkout-product-item .img-product {
                                    position: relative;
                                    width: 70px;
                                    height: 70px;
                                    flex-shrink: 0;
                                    border-radius: 8px;
                                    overflow: hidden;
                                }

                                    .checkout-product-item .img-product img {
                                        width: 100%;
                                        height: 100%;
                                        object-fit: cover;
                                    }

                                .checkout-product-item .quantity {
                                    position: absolute;
                                    top: -8px;
                                    right: -8px;
                                    background: #000;
                                    color: #fff;
                                    width: 24px;
                                    height: 24px;
                                    border-radius: 50%;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    font-size: 11px;
                                    font-weight: 600;
                                }

                                .checkout-product-item .content {
                                    flex: 1;
                                    display: flex;
                                    justify-content: space-between;
                                    align-items: flex-start;
                                }

                                .checkout-product-item .name {
                                    font-size: 14px;
                                    font-weight: 500;
                                    margin: 0 0 4px 0;
                                }

                                .checkout-product-item .variant {
                                    font-size: 12px;
                                    color: #666;
                                }

                                .checkout-product-item .price {
                                    font-size: 14px;
                                    font-weight: 600;
                                }
                        </style>

                                <ul class="wrap-checkout-product">
                                    @foreach (var item in Model!.CartItems)
                                    {
                                        <li class="checkout-product-item">
                                            <figure class="img-product">
                                                <img src="~/images/products/@item.ImageUrl" alt="@item.ProductName">
                                                <span class="quantity">@item.Quantity</span>
                                            </figure>
                                            <div class="content">
                                                <div class="info">
                                                    <p class="name">@item.ProductName</p>
                                                    @if (!string.IsNullOrEmpty(item.Color))
                                                    {
                                                        <span class="variant">@item.Color</span>
                                                    }
                                                </div>
                                                <span class="price">$@item.Subtotal.ToString("0.00")</span>
                                            </div>
                                        </li>
                                    }
                                </ul>

                        <div class="coupon-box">
                            <input asp-for="DiscountCode" type="text" placeholder="Discount code" id="discountCodeInput">
                            <button type="button" id="apply-discount" class="tf-btn btn-sm radius-3 btn-fill btn-icon animate-hover-btn">
                                Apply
                            </button>
                        </div>

                        <div id="discount-message" class="alert" style="display: none; margin-top: 10px;"></div>

                        <div class="d-flex justify-content-between line pb_20">
                            <h6 class="fw-5">Total</h6>
                            <h6 class="total fw-5" id="totalAmount">$@Model.TotalAmount.ToString("0.00")</h6>
                        </div>

                        <div class="wd-check-payment">
                            <div class="fieldset-radio mb_20">
                                <input asp-for="PaymentMethod" type="radio" value="BankTransfer" id="bank" class="tf-check" checked>
                                <label for="bank">Direct bank transfer</label>
                            </div>
                            <div class="fieldset-radio mb_20">
                                <input asp-for="PaymentMethod" type="radio" value="CashOnDelivery" id="delivery" class="tf-check">
                                <label for="delivery">Cash on delivery</label>
                            </div>
                            <span asp-validation-for="PaymentMethod" class="text-danger"></span>

                            <p class="text_black-2 mb_20">
                                Your personal data will be used to process your order, support your experience throughout this website, and for other purposes described in our 
                                <a href="/privacy-policy" class="text-decoration-underline">privacy policy</a>.
                            </p>

                            <div class="box-checkbox fieldset-radio mb_20">
                                <input asp-for="AcceptTerms" type="checkbox" id="check-agree" class="tf-check">
                                <label for="check-agree" class="text_black-2">
                                    I have read and agree to the website 
                                    <a href="/terms-conditions" class="text-decoration-underline">terms and conditions</a>.
                                </label>
                            </div>
                            <span asp-validation-for="AcceptTerms" class="text-danger"></span>
                        </div>

                        <button type="submit" class="tf-btn radius-3 btn-fill btn-icon animate-hover-btn justify-content-center">
                            Place order
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</section>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    
    <script>
        const originalTotal = @Model.TotalAmount;
        let currentDiscount = 0;

        document.getElementById('apply-discount')?.addEventListener('click', function() {
            const code = document.getElementById('discountCodeInput').value;
            const messageDiv = document.getElementById('discount-message');
            
            if (!code) {
                messageDiv.className = 'alert alert-warning';
                messageDiv.textContent = 'Please enter a discount code';
                messageDiv.style.display = 'block';
                return;
            }

            fetch('/Checkout/ApplyDiscount', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ code: code })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentDiscount = data.discount;
                    const newTotal = originalTotal * (1 - currentDiscount / 100);
                    
                    document.getElementById('totalAmount').textContent = '$' + newTotal.toFixed(2);
                    
                    messageDiv.className = 'alert alert-success';
                    messageDiv.textContent = 'Discount applied: ' + data.discount + '% off!';
                    messageDiv.style.display = 'block';
                   
                    this.disabled = true;
                    this.textContent = 'Applied';
                } else {
                    messageDiv.className = 'alert alert-danger';
                    messageDiv.textContent = 'Invalid discount code';
                    messageDiv.style.display = 'block';
                }
            })
            .catch(err => {
                console.error(err);
                messageDiv.className = 'alert alert-danger';
                messageDiv.textContent = 'Error applying discount';
                messageDiv.style.display = 'block';
            });
        });
    </script>
}